# å¾®ä¿¡æ”¯ä»˜åç«¯å¼€å‘æç¤ºè¯

## ğŸš€ å¿«é€Ÿå¼€å§‹

### éœ€è¦å®ç°çš„APIæ¥å£

1. **`POST /goods/payment/wechat/prepare`** - è·å–æ”¯ä»˜å‚æ•°ï¼ˆç»Ÿä¸€ä¸‹å•ï¼‰
2. **`POST /goods/payment/wechat/query`** - æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€  
3. **`POST /goods/payment/wechat/sync`** - åŒæ­¥æ”¯ä»˜ç»“æœ
4. **`POST /goods/payment/wechat/notify`** - æ”¯ä»˜ç»“æœé€šçŸ¥ï¼ˆå¼‚æ­¥å›è°ƒï¼‰

### æ ¸å¿ƒæµç¨‹

```
ç”¨æˆ·æ”¯ä»˜ â†’ ç»Ÿä¸€ä¸‹å• â†’ è¿”å›æ”¯ä»˜å‚æ•° â†’ å°ç¨‹åºè°ƒèµ·æ”¯ä»˜ â†’ æ”¯ä»˜æˆåŠŸ â†’ å¼‚æ­¥é€šçŸ¥ + ä¸»åŠ¨æŸ¥è¯¢
```

## ğŸ”‘ å…³é”®è¦ç‚¹

### 1. ç»Ÿä¸€ä¸‹å•æ¥å£ (/prepare)
```json
// å‰ç«¯è¯·æ±‚
{
  "order_id": "è®¢å•ID",
  "order_number": "è®¢å•å·", 
  "total_fee": 100,  // åˆ†ä¸ºå•ä½
  "body": "å•†å“æè¿°",
  "openid": "ç”¨æˆ·openid"
}

// è¿”å›ç»™å‰ç«¯çš„æ”¯ä»˜å‚æ•°
{
  "timeStamp": "æ—¶é—´æˆ³",
  "nonceStr": "éšæœºä¸²",
  "package": "prepay_id=xxx",
  "signType": "MD5",
  "paySign": "ç­¾å"
}
```

### 2. å¾®ä¿¡APIè°ƒç”¨è¦ç‚¹
- **æ¥å£åœ°å€**: `https://api.mch.weixin.qq.com/pay/unifiedorder`
- **å¿…é¡»å‚æ•°**: appid, mch_id, nonce_str, body, out_trade_no, total_fee, notify_url, trade_type(JSAPI), openid, sign
- **ç­¾åç®—æ³•**: MD5ç­¾åï¼Œå‚æ•°æŒ‰å­—å…¸åºæ‹¼æ¥
- **é€šä¿¡æ–¹å¼**: XMLæ ¼å¼ï¼ŒHTTPSåè®®

### 3. æ•°æ®åº“è®¾è®¡å»ºè®®
```sql
-- å•†æˆ·æ”¯ä»˜é…ç½®è¡¨
CREATE TABLE merchant_payment_config (
  id BIGINT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  merchant_name VARCHAR(100),
  merchant_id VARCHAR(20),
  api_key VARCHAR(32),
  cert_path VARCHAR(200),
  is_enabled BOOLEAN DEFAULT false,
  is_verified BOOLEAN DEFAULT false
);

-- æ”¯ä»˜è®°å½•è¡¨  
CREATE TABLE payment_records (
  id BIGINT PRIMARY KEY,
  order_id BIGINT NOT NULL,
  transaction_id VARCHAR(50),
  prepay_id VARCHAR(50),
  total_fee INT,
  trade_state VARCHAR(20),
  pay_time TIMESTAMP,
  notify_time TIMESTAMP
);
```

## âš¡ å¿«é€Ÿå®ç°æ¨¡æ¿

### Python Flask ç¤ºä¾‹
```python
@app.route('/goods/payment/wechat/prepare', methods=['POST'])
def prepare_payment():
    data = request.get_json()
    
    # 1. éªŒè¯è®¢å•
    order = Order.query.get(data['order_id'])
    if not order or order.status != 'unpaid':
        return error_response('è®¢å•çŠ¶æ€é”™è¯¯')
    
    # 2. æ„å»ºå¾®ä¿¡æ”¯ä»˜å‚æ•°
    params = {
        'appid': WECHAT_APPID,
        'mch_id': WECHAT_MCH_ID,
        'nonce_str': generate_nonce_str(),
        'body': data['body'],
        'out_trade_no': data['order_number'],
        'total_fee': data['total_fee'],
        'notify_url': f'{BASE_URL}/goods/payment/wechat/notify',
        'trade_type': 'JSAPI',
        'openid': data['openid']
    }
    
    # 3. ç”Ÿæˆç­¾åå¹¶è°ƒç”¨å¾®ä¿¡API
    params['sign'] = generate_sign(params, WECHAT_API_KEY)
    response = call_wechat_unifiedorder(params)
    
    # 4. ç”Ÿæˆå°ç¨‹åºæ”¯ä»˜å‚æ•°
    if response['return_code'] == 'SUCCESS':
        pay_params = generate_jsapi_params(response['prepay_id'])
        return success_response(pay_params)
    else:
        return error_response('ç»Ÿä¸€ä¸‹å•å¤±è´¥')

@app.route('/goods/payment/wechat/notify', methods=['POST'])
def payment_notify():
    xml_data = request.data
    data = parse_xml(xml_data)
    
    # éªŒè¯ç­¾å
    if not verify_sign(data, WECHAT_API_KEY):
        return error_xml()
    
    # å¤„ç†æ”¯ä»˜ç»“æœ
    if data['result_code'] == 'SUCCESS':
        update_order_status(data['out_trade_no'], data['transaction_id'])
    
    return success_xml()
```

### Node.js Express ç¤ºä¾‹
```javascript
app.post('/goods/payment/wechat/prepare', async (req, res) => {
  const { order_id, order_number, total_fee, body, openid } = req.body;
  
  // 1. éªŒè¯è®¢å•
  const order = await Order.findById(order_id);
  if (!order || order.status !== 'unpaid') {
    return res.json({ code: 400, message: 'è®¢å•çŠ¶æ€é”™è¯¯' });
  }
  
  // 2. è°ƒç”¨å¾®ä¿¡ç»Ÿä¸€ä¸‹å•
  const payParams = {
    appid: WECHAT_APPID,
    mch_id: WECHAT_MCH_ID,
    nonce_str: generateNonceStr(),
    body,
    out_trade_no: order_number,
    total_fee,
    notify_url: `${BASE_URL}/goods/payment/wechat/notify`,
    trade_type: 'JSAPI',
    openid
  };
  
  payParams.sign = generateSign(payParams, WECHAT_API_KEY);
  
  const result = await callWeChatAPI(payParams);
  
  if (result.return_code === 'SUCCESS') {
    const jsapiParams = generateJSAPIParams(result.prepay_id);
    res.json({ code: 200, data: jsapiParams });
  } else {
    res.json({ code: 500, message: 'ç»Ÿä¸€ä¸‹å•å¤±è´¥' });
  }
});
```

## ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] ç­¾åéªŒè¯æ­£ç¡®å®ç°
- [ ] APIå¯†é’¥å®‰å…¨å­˜å‚¨ï¼ˆä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ï¼‰
- [ ] HTTPSé€šä¿¡
- [ ] è®¢å•çŠ¶æ€å¹‚ç­‰æ€§å¤„ç†
- [ ] å¼‚å¸¸æƒ…å†µå›æ»šæœºåˆ¶
- [ ] æ”¯ä»˜é‡‘é¢éªŒè¯ï¼ˆé˜²æ­¢ç¯¡æ”¹ï¼‰
- [ ] é€šçŸ¥æ¥å£é˜²é‡æ”¾æ”»å‡»

## ğŸ”§ è°ƒè¯•å·¥å…·

1. **å¾®ä¿¡æ”¯ä»˜æ²™ç®±**: ç”¨äºæµ‹è¯•ç¯å¢ƒ
2. **ç­¾åå·¥å…·**: å¾®ä¿¡æ”¯ä»˜å®˜æ–¹æä¾›çš„ç­¾åéªŒè¯å·¥å…·
3. **æ—¥å¿—è®°å½•**: è®°å½•æ‰€æœ‰æ”¯ä»˜ç›¸å…³çš„è¯·æ±‚å’Œå“åº”

## ğŸ“ æµ‹è¯•è¦ç‚¹

1. **æ­£å¸¸æ”¯ä»˜æµç¨‹**: å®Œæ•´çš„æ”¯ä»˜æˆåŠŸæµç¨‹
2. **å¼‚å¸¸å¤„ç†**: ç½‘ç»œè¶…æ—¶ã€æ”¯ä»˜å¤±è´¥ã€é‡å¤é€šçŸ¥
3. **é‡‘é¢æµ‹è¯•**: å„ç§é‡‘é¢æ ¼å¼ï¼ˆæ³¨æ„åˆ†/å…ƒè½¬æ¢ï¼‰
4. **å¹¶å‘æµ‹è¯•**: å¤šç”¨æˆ·åŒæ—¶æ”¯ä»˜
5. **è®¢å•çŠ¶æ€**: ç¡®ä¿çŠ¶æ€æµè½¬æ­£ç¡®

## ğŸš¨ å¸¸è§é—®é¢˜

1. **ç­¾åé”™è¯¯**: æ£€æŸ¥å‚æ•°æ’åºå’Œç¼–ç æ ¼å¼
2. **é‡‘é¢ä¸åŒ¹é…**: å‰ç«¯ä¼ å…ƒï¼Œå¾®ä¿¡è¦åˆ†
3. **è¯ä¹¦é—®é¢˜**: é€€æ¬¾åŠŸèƒ½éœ€è¦è¯ä¹¦æ–‡ä»¶
4. **é€šçŸ¥åœ°å€**: å¿…é¡»æ˜¯å¤–ç½‘å¯è®¿é—®çš„HTTPSåœ°å€
5. **ç¼–ç é—®é¢˜**: ç¡®ä¿UTF-8ç¼–ç 

## ğŸ“ è”è°ƒå‡†å¤‡

å‰ç«¯å·²å‡†å¤‡å°±ç»ªï¼Œåç«¯å®ç°åå¯ç›´æ¥è”è°ƒï¼š
- å‰ç«¯ä¼šä¼ é€’æ­£ç¡®æ ¼å¼çš„å‚æ•°
- è¿”å›æ•°æ®æ ¼å¼å·²å¯¹é½
- é”™è¯¯å¤„ç†æœºåˆ¶å·²å®ç°

**é‡è¦**: è¯·å…ˆåœ¨æ²™ç®±ç¯å¢ƒæµ‹è¯•ï¼Œç¡®è®¤æ— è¯¯åå†ä¸Šç”Ÿäº§ç¯å¢ƒï¼ 